$.extend(Array.prototype,{find:function(n,t){var i=null;return $.each(this,function(){if(typeof n=="function"?n(this):this[n]==t)return i=this,!1}),i},indexOf:function(n){for(var t=0;t<this.length;t++)if($.isFunction(n)?n(this[t]):this[t]===n)return t;return-1},remove:function(n){var t=this.indexOf(n);return t>-1?(this.splice(t,1),!0):!1},copy:function(){for(var t=[],n=0;n<this.length;n++)t.push($.extend({},this[n]));return t},last:function(n){if(this.length>0)if(typeof n=="function"){for(var t=this.length-1;t>=0;t--)if(n(this[t],t,this))return this[t]}else return this[this.length-1];return null}});$.extend(String.prototype,{trim:function(){return this.replace(/(^\s*)|(\s*$)/g,"")},isGuid:function(){return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(this)}});$.extend({isString:function(n){return typeof n=="string"}});$.fn.extend({bindData:function(n){return this.find("[data-bind]").each(function(){var i="opt = {"+$(this).data("bind")+"};",t;eval(i);for(t in opt)t=="text"?$(this).text(n[opt[t]]):t=="css"&&$(this).addClass(n[opt[t]])}),this},serializeObject:function(){var t=this.serializeArray(),n={};return $.each(t,function(){n[this.name]=this.value}),n},marginHeight:function(){return this.outerHeight()+parseInt(this.css("marginTop"))+parseInt(this.css("marginBottom"))}});var fruit={};fruit.keyCode={ENTER:13,ESC:27,UP:38,DOWN:40};fruit.STATE_UNCHANGE=0;fruit.STATE_NEW=1;fruit.STATE_CHANGED=2;fruit.STATE_DELETED=3;fruit.findValue=function(n,t){for(var r=t.split("."),i=0;n&&typeof n[r[i]]!="undefined";){if(i==r.length-1)return n[r[i]];n=n[r[i]];i++}};fruit.setValue=function(n,t,i){for(var r=t.split("."),u=0;n;){if(u>=r.length-1){n[r[u]]=i;return}n[r[u]]||(n[r[u]]={});n=n[r[u++]]}};fruit.findDataSourceText=function(n,t,i){if(n&&$.isArray(n[t])){var r=n[t].find("value",i);if(r)return r.text}return i};fruit.toDateValue=function(n){return n?n.replace("T"," "):n};fruit.parseOptions=function(){for(var i,t,e,r,o,u,f=-1,n=0;n<arguments.length;n++)if(typeof arguments[n]=="string"){f=n;break}if(i={},f==-1){for(i=arguments[arguments.length-1],n=arguments.length-2;n>=0;n--)$.extend(i,arguments[n]);return i}for(n=f;n<arguments.length;n++)for(t=arguments[n],e=0;e<f;e++){if(r=arguments[e],r&&r.tagName){if(o=$.attr(r,t),typeof o!="undefined"){i[t]=o;break}if(u=$(r).data("options"),eval("dataOpt = {"+u+"};"),u&&typeof u[t]!="undefined"){i[t]=u[t];break}}if(typeof r!="undefined"&&typeof r[t]!="undefined"){i[t]=r[t];break}}return i};fruit.ajax=function(n){n=$.extend({showLoading:!0},n);var t={type:"POST",dataType:"json",contentType:"application/json",error:function(n){var t=n.responseText,i=t.match(/^{\"Message\":\"(.*)\",\"ExceptionMessage\":\"(.*)\",\"ExceptionType\":.*/);if(i!=null)t=(i[1]+i[2]).replace(/\\"/g,'"').replace(/\\r\\n/g,"<br/>").replace(/dbo\./g,"");else try{t=$(t).text()||t}catch(r){}fruit.message("error",t)}};n.showLoading&&(t.beforeSend=$.showLoading,t.complete=$.hideLoading);$.ajax($.extend(t,n))};fruit.message=function(n,t,i){switch(n){case"success":if(parent==window)return alert(t);parent.$.notify.create(t,{type:"success",sticky:!1,style:"bar",appendTo:"#notification"});break;case"error":if(parent==window)return alert(t);parent.$.messager.alert("错误",t);break;case"warning":if(parent==window)return alert(t);parent.$.notify.create(t,{type:"warning",sticky:!1,style:"bar",appendTo:"#notification"});break;case"information":parent.$.messager.show({title:"消息",msg:t});break;case"confirm":return parent.$.messager.confirm("确认",t,i)}return i&&i(),null};fruit.equalIgnorecase=function(n,t){return n==t?!0:n==null&&t==null?!0:n!=null&&t!=null?n.toUpperCase()==t.toUpperCase():!1};fruit.cookie=function(n,t){for(var f,r,u=document.cookie.split(";"),i=0;i<u.length;i++)if(f=u[i],r=f.split("="),r[0].trim()==n){if(arguments.length==1)return r[1];break}arguments.length>1&&(document.cookie=n+"="+t)};fruit.select={};fruit.select.fillData=function(n,t){$(n).empty();$.each(t,function(){var t=$("<option><\/option>").text(this.Text).attr("value",this.Value).appendTo(n);this.Selected&&t.attr("selected","selected")})};fruit.tree={};fruit.tree.each=function(n,t){for(var i=0;i<n.length;i++)if(t.call(n[i],i)===!1||n[i].children&&fruit.tree.each(n[i].children,t)===!1)return!1};fruit.tree.remove=function(n,t){for(var i=0;i<n.length;i++)t(n[i])?(n.splice(i,1),i--):n[i].children&&fruit.tree.remove(n[i].children,t)};fruit.tree.findNodeData=function(n,t,i){var r,u;for(arguments.length<3&&(i="_id"),r=0;r<n.length;r++){if(n[r][i]==t||n[r]._id==t)return n[r];if(n[r].children&&(u=fruit.tree.findNodeData(n[r].children,t,i),u!=null))return u}return null};fruit.tree.createLoadFilter=function(n,t,i,r){function o(i,r){for(var u=0;u<i.length;u++)i[u][t]==r[n]&&(r.children?r.children.push(i[u]):r.children=[i[u]],f(i[u],r),o(i,i[u]))}for(var e=[],f=$.noop,u=2;u<arguments.length;u++)typeof arguments[u]=="function"?(f=arguments[u],r===f&&(r=undefined)):arguments[u]&&arguments[u].text?r=arguments[u]:e.push(arguments[u]);return function(n){var u,i,h,s;for(n.total&&n.rows&&(n=n.rows),u=[],i=0;i<n.length;i++){for(h=!1,s=0;s<e.length;s++)if(n[i][t]==e[s]){h=!0;break}h&&(u.push(n[i]),f(n[i]),o(n,n[i]))}return r&&(u=[r].concat(u)),u}};fruit.tree.createOrganizeFilter=function(){function n(t,i){for(var r=0;r<t.length;r++)t[r].parentId==i.id&&t[r]!=i&&(i.children?i.children.push(t[r]):i.children=[t[r]],t[r].nodeType=="Organize"?n(t,t[r]):t[r].iconCls="icon-user")}return function(t){var i=null,r;return $.each(t,function(){if(this.parentId=="#root#")return i=this,!1}),r=[i],n(t,i),r}};fruit.tree.collapseChildren=function(n,t){$(".easyui-combotree").each(function(){var n=$(this).data(),i,r;if(n&&n.combotree&&n.combotree.tree&&n.combotree.tree.find(">li>.tree-node").is(t[0].target))return i=$(this).combotree("tree").tree("getRoot"),r=$(this).combotree("tree"),r.tree("collapseAll",i.target),!1})};fruit.ExpandChildrenTable=function(n,t,i,r,u,f,e){var s=$(n).datagrid("getRowDetail",u),o,h,c,l,a;s.find("table").length||(o=$("#"+i).html(),h=i.split("_")[1],o=o.replace(new RegExp("gridtb"+h,"g"),"gridtb"+h+"_"+u),s.html(o),c=window["detailOnExpandRow"+r].options,$.extend(c,{onLoadSuccess:function(){setTimeout(function(){$(n).datagrid("fixDetailRowHeight",u)},0)},onBeforeAdd:function(n){$.each(e,function(t){n[this]=f[t]});f._id_&&(n._pid_=f._id_)}}),l=new fruit.databind(s[0],c),$(n).datagrid("fixDetailRowHeight",u),a=l.binds[0],a.jq.datagrid({height:150,method:"GET",url:t+"?"+$.map(e,function(n,t){return n+"="+f[t]}).join("&"),onResize:function(){$(n).datagrid("fixDetailRowHeight",u)}}))};fruit.resizeHandle=function(){var t=$(window).width(),n=document.createElement("style");n.type="text/css";n.appendChild(document.createTextNode(""));var r=n.sheet,i="max-width:calc("+t+"px - 10em);";n.appendChild(document.createTextNode(".val>.z-txt,.val>.textbox,.val>textarea,.val>.edui-default{"+i+"}"));document.head.appendChild(n);$("#tt").tabs("resize")};$(function(){$(window).on("resize.fruit",fruit.resizeHandle);$(window).triggerHandler("resize.fruit");$("#condition").on("keydown",function(n){n.keyCode==13&&($("[data-bind=\"click:'searchClick'\"]").trigger("click"),n.preventDefault())})});$.fn.showLoading=function(n){return typeof n=="undefined"&&(n="正在加载数据…"),this.each(function(){$('<div class="datagrid-mask-msg" style="display:block;left:50%;"><\/div>').text(n).insertAfter(this);$('<div class="datagrid-mask" style="display:block"><\/div>').insertAfter(this)})};$.fn.hideLoading=function(){return this.parent().find("div.datagrid-mask,div.datagrid-mask-msg").remove(),this};$.fn.bodyOffset=function(){for(var n=$($(this)[0]),i=n.offset(),t;!!(n=n.offsetParent());){if(n[0]==document||n[0]==document.body||n[0].tagName=="HTML")break;t=n.offset();t&&($.isNumeric(t.left)&&(i.left+=t.left),$.isNumeric(t.top)&&(i.top+=t.top))}return i};$(function(){var n=function(n,t){var i=this;i.jq=$(n);i.options=fruit.parseOptions(n,t,{method:"get"},"url","method");i.oldValue="";i.waitTime=null;i.panel=null;i.load=function(){var n=i.jq.val(),t;if(i.oldValue!=n){if(i.oldValue=n,i.oldValue==""){i.close();return}t=$.extend({},{data:"q="+i.oldValue,success:function(n){i.options.rows=n;i.options.rows.length>0?i.show():i.close()}},i.options);fruit.ajax(t)}};i.autoSelect=function(){i.panelBody.find(".combobox-item-selected").length?i.panelBody.find(".combobox-item-selected").trigger("click"):$(i.panelBody.find(".combobox-item")[0]).trigger("click")};i.select=function(n){i.jq.val(i.options.rows[n])};i.show=function(){i.panel==null&&(i.panel=$('<div style="position: absolute;"><\/div>').appendTo(document.body),i.panelBody=$('<div style="border: solid 1px #95B8E7; background-color:white; cursor:default;"><\/div>').appendTo(i.panel));i.panelBody.empty();$.each(i.options.rows,function(n){$('<div class="combobox-item"><\/div>').data("rowIndex",n).text(this).appendTo(i.panelBody).hover(function(){$(this).addClass("combobox-item-hover")},function(){$(this).removeClass("combobox-item-hover")}).click(function(){var n=$(this).data("rowIndex");n>-1&&n<i.options.rows.length&&(i.select(n),i.close())})});var n=i.jq.bodyOffset();i.panel.css({width:i.jq.outerWidth(),left:n.left,top:n.top}).show();i.options.opened=!0};i.close=function(){i.panel&&i.panel.hide();i.options.opened=!1};i.jq.on("keydown",function(n){if(i.options.opened){var t=i.panelBody.find(".combobox-item-selected").index();switch(n.keyCode){case fruit.keyCode.ENTER:i.autoSelect();break;case fruit.keyCode.ESC:i.close();break;case fruit.keyCode.DOWN:t++;t<i.options.rows.length&&(i.panelBody.find(".combobox-item").removeClass("combobox-item-selected"),$(i.panelBody.find(".combobox-item")[t]).addClass("combobox-item-selected"));break;case fruit.keyCode.UP:t--;t>-1&&(i.panelBody.find(".combobox-item").removeClass("combobox-item-selected"),$(i.panelBody.find(".combobox-item")[t]).addClass("combobox-item-selected"))}}});i.jq.on("keypress keyup",function(){clearTimeout(i.waitTime);i.waitTime=setTimeout(function(){i.load()},500)});i.jq.on("blur",function(){setTimeout(function(){i.close()},200)})};$.fn.autocomplete=function(t){this.each(function(){var r=$(this),i=$.data(r,"autocomplete");i||(i=new n(this,t),$.data(r,"autocomplete",i))})};$(".easyui-autocomplete").autocomplete()});$(function(){var n=function(t){var i=this;this.options=$.extend({},n.defaults,t);this.bg=$('<div style="position: absolute;left:0;top:0;right:0;bottom:0;z-index:9999999;background-color:rgba(0,0,0,0.5);display:none;"><\/div>').appendTo(top.document.body);this.img=$('<div style="width:100%;height:100%;background:no-repeat;background-size:contain;background-position:center center;"><\/div>').appendTo(this.bg);this.btnPrev=$('<div style="position: absolute; top:0;left:0;bottom:0;width:25%;cursor:pointer;" title="上一张"><\/div>').appendTo(this.bg).on("click",function(){i.prev()});this.btnNext=$('<div style="position: absolute; top:0;right:0;bottom:0;width:25%;cursor:pointer;" title="下一张"><\/div>').appendTo(this.bg).on("click",function(){i.next()});this.btnClose=$('<span class="icon-cross" style="position: absolute;display:block;top:10px;right:10px;width: 20px;height: 20px;background-color: black;background-position: center center;cursor:pointer;"><\/span>').appendTo(this.bg).on("click",function(){i.close()});this.imglist=$('<div style="display: block;position: relative;top:-100px;text-align: center;margin: 0 auto;opacity:0;background-color:rgba(0,0,0,0.8);padding:10px 0;"><\/div>').appendTo(this.bg).mouseenter(function(){$(this).css("opacity",.8)}).mouseleave(function(){$(this).css("opacity",0)})},t=n.prototype;t.close=function(){this.bg.fadeOut("fast")};t.goto=function(n){this.options.index=n;this.img.css("background-image","url("+this.options.images[n]+")")};t.prev=function(){this.options.index>0&&this.goto(this.options.index-1)};t.next=function(){this.options.index+1<this.options.images.length&&this.goto(this.options.index+1)};t.show=function(){var n=this;n.imglist.empty();$.each(n.options.images,function(t){t==n.options.index&&n.img.css("background-image","url("+this+")");var i=$('<div style="display:inline-block;width:80px;height:80px;background:no-repeat;background-size:cover;cursor:pointer"><\/div>').css("background-image","url("+this+")").appendTo(n.imglist).on("click",function(){n.goto(t)});t>0&&i.css("margin-left",10)});n.bg.fadeIn("fast")};n.defaults={images:[],index:0,overpanel:null,image:null};n.instaince=null;$.pictureWall=function(t){return n.instaince==null?n.instaince=new n(t):n.instaince.options=$.extend({},n.defaults,t),n.instaince}});fruit.plugin={};fruit.plugin.showPopupSelect=function(n){function i(n,i){var r=t.table.data("value-fields").split(","),u=n.datagrid("getRows");return u.indexOf(function(n){for(var t=0;t<r.length;t++)if(i[r[t]]!=n[r[t]])return!1;return!0})}function r(){var n=t.selectedTable.datagrid("getRows").length;t.info.html('双击选择或删除，已选中 <font color="red">'+n+"<\/font> 条数据")}function u(n){var u=i(t.selectedTable,n);u==-1&&(t.selectedTable.datagrid("appendRow",n),r())}function f(n){var u=i(t.selectedTable,n);u>-1&&(t.selectedTable.datagrid("deleteRow",u),r())}var t=$("<div><\/div>");t.on("dblclick",".datagrid-row",function(n){var i=$(this).closest(".datagrid-view").find(">table"),r=$(this).closest(".datagrid-row").attr("datagrid-row-index"),t=i.datagrid("getRows")[r];return t&&(i.is(".selectedTable")?f(t):u(t)),n.preventDefault(),n.stopPropagation(),!1});t.dialog({title:n.title,width:n.width,height:n.height,closed:!1,cache:!1,href:"/Plugins/Popup/"+n.rule,buttons:[{text:"确认",iconCls:"icon-ok",handler:function(){var i=t.find('[data-bind="datagrid"]'),r=t.selectedTable.datagrid("getRows"),u=i.data("value-fields").split(","),f=i.data("return-fields").split(",");$.each(r,function(){n.onSelect(this,u,f)});t.dialog("close")}}],modal:!0,onLoad:function(){t.table=t.dialog("dialog").find("table[data-bind]").datagrid({singleSelect:!0});t.table.attr("readonly","readonly");t.info=$('<div style="float:left;position: relative;z-index:100;padding:6px;color:#666">双击选择或删除<\/div>').appendTo(t.dialog("dialog").find(".dialog-button"));t.selectedTable=$('<table class="selectedTable" style="height:100px;">'+t.dialog("dialog").find('[data-bind="datagrid"]').html()+"<\/table>").appendTo(t.dialog("dialog").find(".window-body")).datagrid({border:!1,rownumbers:!0});t.selectedTable.attr("readonly","readonly")},onClose:function(){t.dialog("destroy")}})};$(function(){function n(n){function r(n,i){if(t.popupGrid){var r=t.popupGrid.data("value-fields").split(",");return n[r[0]]==i[r[0]]}return!1}function u(){var e,n;if(t.selinfo&&t.popupGrid&&t.selectedRows){if(t.selectedRows.length==0){t.selinfo.text("未选择");return}var r=[],u=0,f=!1,i=t.popupGrid.data("list-fields").split(","),o=i.length>1?i[1]:i[0];for(e of t.selectedRows){if(n=e[o],u+n.length>16){f=!0;break}u+=n.length;r.push(n)}t.selinfo.text("已选择 "+r.join()+" "+(f?"等，共 ":"共 ")+t.selectedRows.length+" 项")}}function s(n,i){var f,e;if(!t._lockSelectedRows&&t.selinfo&&t.popupGrid){if(t.popupGrid.datagrid("options").singleSelect)t.selectedRows=[];else for(f in t.selectedRows)if(e=t.selectedRows[f],r(i,e)){t.selectedRows.splice(f,1);break}u()}t.oldPopupGridOnUnselect&&t.oldPopupGridOnUnselect(n,i)}function h(n,i){var f,e;if(!t._lockSelectedRows&&t.selinfo&&t.popupGrid){if(t.popupGrid.datagrid("options").singleSelect)t.selectedRows=[i];else{f=!1;for(e of t.selectedRows)if(r(i,e)){f=!0;break}f||t.selectedRows.push(i)}u()}t.oldPopupGridOnSelect&&t.oldPopupGridOnSelect(n,i)}function c(n){var i,f,u,e;if(t.oldPopupGridOnLoadSuccess&&t.oldPopupGridOnLoadSuccess(n),n&&n.rows&&t.popupGrid&&t.selectedRows&&t.selectedRows.length){t._lockSelectedRows=!0;for(i in n.rows){f=n.rows[i];u=!1;for(e of t.selectedRows)if(r(f,e)){u=!0;break}u&&t.popupGrid.datagrid("selectRow",i)}t._lockSelectedRows=!1}}function l(){t.selectedRows=[];var r=$("<div><\/div>");r.dialog({title:i.title,width:i.dialogWidth,height:i.dialogHeight,closed:!1,cache:!1,href:"/Plugins/Popup/"+i.rule,buttons:[{text:"选择",iconCls:"icon-ok",handler:function(){var f=r.find('[data-bind="datagrid"]'),u,s;if(i.onSelect===fruit.popupSelecteds||i.onSelect===fruit.popupColumnSelecteds){if(i.maxChoiceItems>0&&t.selectedRows.length>i.maxChoiceItems){alert("最多选择 "+i.maxChoiceItems+" 项！");return}var o=f.data("value-fields").split(","),e=f.data("list-fields").split(","),l=e.length>1?e[1]:e[0],h=[],c=[];for(u of t.selectedRows)h.push(u[o]),c.push(u[l]);i.onSelect($(n),h,c);r.dialog("close")}else if(u=f.datagrid("getSelected"),u){var o=f.data("value-fields").split(","),e=f.data("list-fields").split(","),a=f.data("return-fields").split(",");$(n).val(u[o[0]]);s=e.length>1?u[e[1]]:u[e[0]];$.fn.popup.methods.setText($(n),s);i.onSelect(u,o,a,i.textField,s);r.dialog("close")}}}],modal:!0,onClose:function(){r.dialog("destroy")},onLoad:function(){var u=$("<div>未选择<\/div>"),n;u.css({position:"absolute",left:5,top:5,bottom:5,right:75,textAlign:"left",lineHeight:"24px"});u.appendTo(r.parent().find(".dialog-button"));t.selinfo=u;t.popupGrid=r.find('[data-bind="datagrid"]');n=t.popupGrid.datagrid("options");t.oldPopupGridOnSelect=n.onSelect;n.onSelect=h;t.oldPopupGridOnUnselect=n.onUnselect;n.onUnselect=s;t.oldPopupGridOnLoadSuccess=n.onLoadSuccess;n.onLoadSuccess=c;n.singleSelect=!i.multipleChoice;t.popupBind=fruit.databind.get(t.popupGrid)}});$(r.data("panel").panel).on("dblclick",".datagrid-row",function(){r.dialog("options").buttons[0].handler()})}function f(n,t){n.popup.removeClass("open");var i=n.options.displayFields.split("|"),r=t[i[3]],u=t[i[1].split(",")[0]];if(n.textbox.val(r),n.$target.val(u),typeof n.options.onSelect=="function"){function r(n){var t=n.split(",");return t.length==1&&t[0].length==0?[]:t}n.options.onSelect(t,r(i[1]),r(i[2]),i[3],t[i[3]])}}function e(n){var t=n.popup.find(".dropdown-item.selected").data("item");t&&n.popup.is(".open")?f(n,t):n.textbox.val()==""&&n.$target.val("")}function a(n,t){var i,r,u;n.popup||(n.popup=$('<div class="popup-dropdown"><\/div>').appendTo(document.body));i=n.box.offset();n.popup.css({left:i.left,top:i.top+n.box.outerHeight()});r=$('<table width="100%">');n.popup.empty().append(r);u=!0;$.each(t.rows,function(){var i=$('<tr class="dropdown-item">').data("item",this).appendTo(r).on("click",function(){f(n,$(this).data("item"))}),e,o,t;if(u&&(i.addClass("selected"),u=!1),n.options.displayFields&&n.options.displayFields.length){e=n.options.displayFields.split("|")[0].split(",");for(t in e)o=this[e[t]],typeof o!="function"&&$("<td>").text(o).appendTo(i)}else for(t in this)typeof this[t]!="function"&&$("<td>").text(this[t]).appendTo(i)});n.textbox.is(":focus")&&t.rows.length?n.popup.addClass("open"):n.popup.removeClass("open")}function o(n){n.busy||(n.busy=!0,n.ajax=$.ajax({url:"/Plugins/GetLookupData/"+i.rule,data:{page:1,rows:10,_input:n.textbox.val()}}).done(function(t){a(n,t)}).always(function(){n.busy=!1}))}var t=$.data(n,"popup"),i=t.options;if($(n).css("display","none"),!t.box){t.$target=$(n);t.box=$('<span class="textbox popup" style="height:20px;"><span class="textbox-addon textbox-addon-right" style="right: 0px;"><a href="javascript:void(0)" class="textbox-icon combo-arrow popup-arrow" icon-index="0" tabindex="-1" style="width: 18px; height: 20px;"><\/a><\/span><input type="text" class="textbox-text" autocomplete="off" placeholder="" style="margin-left: 0px; margin-right: 18px; padding-top: 3px; padding-bottom: 3px; min-width: 4em;"><\/span>').insertAfter(n);t.link=t.box.find("a");t.textbox=t.box.find(".textbox-text");t.textbox.validatebox(i);t.busy=!1;t.textbox.on("input",function(){t.timer&&clearTimeout(t.timer);t.timer=setTimeout(function(){o(t)},300)});t.textbox.on("keydown",function(n){var i;n.keyCode==40?t.popup&&t.popup.is(".open")?(i=t.popup.find(".dropdown-item.selected"),i.next().length&&i.removeClass("selected").next().addClass("selected")):o(t):n.keyCode==38?(i=t.popup.find(".dropdown-item.selected"),i.prev().length&&i.removeClass("selected").prev().addClass("selected")):n.keyCode==27?t.popup.removeClass("open"):n.keyCode==13?e(t):n.keyCode==9&&(e(t),t.textbox.focus())});t.textbox.on("blue",function(){setTimeout(function(){!t.textbox.is(":focus")&&t.popup&&t.popup.removeClass("open")},100)});t.link.click(function(){l()})}}$.fn.popup=function(t,i){if(typeof t=="string"){var r=$.fn.popup.methods[t];return r?r(this,i):this.validatebox(t,i)}return t=t||{},this.each(function(){var i=$.data(this,"popup");i?$.extend(i.options,t):$.data(this,"popup",{options:$.extend({},$.fn.popup.defaults,$.fn.popup.parseOptions(this),t)});n(this)})};$.fn.popup.methods={options:function(n){return $.data(n[0],"popup").options},dialog:function(n){return $.data(n[0],"popup").dialog},setValue:function(n,t){n.val(t)},setText:function(n,t){n.next().find(".textbox-text").val(t);n.next().find(".textbox-text").validatebox("validate")},getText:function(n){return n.next().find(".textbox-text").val()},destroy:function(n){$.removeData(n,"popup")}};$.fn.popup.parseOptions=function(n){var t=$(n);return $.extend({},$.fn.validatebox.parseOptions(n),{})};$.fn.popup.defaults=$.extend({},$.fn.validatebox.defaults,{dialogWidth:550,dialogHeight:400,onSelect:$.noop,textField:null,title:"请选择",rule:"",multipleChoice:!0,maxChoiceItems:0});$(".easyui-popup").popup()});$(function(){function r(t,i){var r=n(t);r.options.value=i}function t(t){var f=$(t),u=n(f);u.options.name==null&&(u.options.name=f.attr("name")||"radiobox_"+i++);$.isArray(u.options.data)&&(f.empty(),$.each(u.options.data,function(){var n=$("<label><\/label>").appendTo(f),t=$('<input type="radio" />').attr("value",this[u.options.valueField]).attr("name",u.options.name).appendTo(n).on("click",function(){r(f,this.value)});this[u.options.valueField]==u.options.value&&(t[0].checked=!0);$('<span class="radio-label"><\/span>').text(this[u.options.textField]).appendTo(n)}))}function n(n){n=$(n);var t=n.data("radiobox");return t||(n.data("radiobox",{options:$.extend({},$.fn.radiobox.defaults,$.parser.parseOptions(n[0]))}),t=n.data("radiobox")),t}var i=1;$.fn.radiobox=function(i,r){if(typeof i=="string"){var u=$.fn.radiobox.methods[i];if(u)return u(this,r)}return i=i||{},this.each(function(){var r=n($(this));$.extend(r.options,i);t(this)})};$.fn.radiobox.methods={loadData:function(i,r){var u=n(i);u.options.data=r;t(i)},setValue:function(i,r){var u=n(i);u.options.value=r;t(i)},getValue:function(t){var i=n(t);return i.options.value}};$.fn.radiobox.defaults={name:null,value:null,valueField:"value",textField:"text",data:[]};$.parser.plugins.push("radiobox")});$(function(){function i(n){for(var t=""+n,r,t=t.split("."),i=[];t[0].length>0;)r=t[0].length%3||3,i.push(t[0].substr(0,r)),t[0]=t[0].substr(r);return t.length>1&&t[1].length>2&&(t[1]=t[1].substr(0,2)),t[0]=i.join("'"),t.join(".")}function a(n){return n>1048576e3?i(n/1048576e3)+" GB":n>1048576?i(n/1048576)+" MB":n>1024?i(n/1024)+" KB":n+" B"}function v(t,i){var r=n(t);r.progress||(r.progress=$('<div class="file-progress"><\/div>').appendTo(r.text));r.progress.css("width",i.loaded*r.text.width()/i.total)}function u(i,r){var u=n(i),f=$.parseJSON(r.target.responseText);u.options.value=f.fileId;u.button.find(".icon").removeClass("icon-upload").addClass("icon-folder_magnify").end().attr("for",u.button.data("for")).attr("title","选择文件...");u.options.numberLimits==1?(u.progress.css("width","100%"),u.options.files=f.files):u.options.files=u.options.files.concat(f.files);t(i)}function f(n,t){console.log("error",t)}function e(n,t){console.log("abort",t)}function y(t,i){var h=n(t),s,o,r;h.button.find(".icon").removeClass("icon-folder_magnify").addClass("icon-upload").end().attr("for","").attr("title","正在上传...");s=$('<span class="file-item"> 正在上传 '+i.length+" 个文件... <\/span>").appendTo(h.box);typeof FormData=="function"?(o=new FormData,o.append("path",h.options.path),o.append("fileId",h.options.value),o.append("replace","False"),$.each(i,function(){o.append("file",this)}),r=new XMLHttpRequest,r.upload.addEventListener("progress",function(n){var t=s.data("progress");t||(t=$('<span class="file-progress"><\/span>').appendTo(s),s.data("progress",t));t.css("width",n.loaded*s.width()/n.total)},!1),r.addEventListener("load",function(n){u(t,n)},!1),r.addEventListener("error",function(n){f(t,n)},!1),r.addEventListener("abort",function(n){e(t,n)},!1),r.open("POST","/File/Upload"),r.send(o)):alert("当前浏览器不支持异步上传！")}function p(t,i){var s=n(t),o,r;s.button.find(".icon").removeClass("icon-folder_magnify").addClass("icon-upload").end().attr("for","").attr("title","正在上传...");typeof FormData=="function"?(o=new FormData,o.append("path",s.options.path),o.append("fileId",s.options.value),o.append("replace","True"),o.append("file",i),r=new XMLHttpRequest,r.upload.addEventListener("progress",function(n){v(t,n)},!1),r.addEventListener("load",function(n){u(t,n)},!1),r.addEventListener("error",function(n){f(t,n)},!1),r.addEventListener("abort",function(n){e(t,n)},!1),r.open("POST","/File/Upload"),r.send(o)):alert("当前浏览器不支持异步上传！")}function o(i,r){var u=n(i),f;u.options.numberLimits==1&&u.delButton.attr("disabled","disabled");f={fileId:u.options.value,serial:r};fruit.ajax({url:"/File/Delete",data:JSON.stringify(f),success:function(){var n=-1;$.each(u.options.files,function(t){if(this.Serial==r)return n=t,!1});u.options.files.splice(n,1);t(i)}})}function w(n){return pos=n.lastIndexOf("\\"),pos>-1&&(n=n.substr(pos+1)),pos=n.lastIndexOf("/"),pos>-1&&(n=n.substr(pos+1)),n}function b(n){var t="",i=n.lastIndexOf(".");return i>-1&&(t=n.substr(i+1)),t}function k(t){var i=n(t),r=i.fileInput[0].files,u;if(r){if(i.options.numberLimits>1&&i.options.files.length+r.length>i.options.numberLimits){fruit.message("warning","最多只能上传 "+i.options.numberLimits+" 个文件！");return}u=!0;$.each(r,function(){if(!s(i,this))return u=!1,!1});u&&y(t,r)}}function s(n,t){if(n.options.typeLimits.length){var r=b(t.name),i=!1;if($.each(n.options.typeLimits.split(","),function(){if(this.toUpperCase()==r.toUpperCase())return i=!0,!1}),!i)return fruit.message("warning","只能选择 "+n.options.typeLimits+" 为扩展名的文件！"),!1}return n.options.sizeLimits&&n.options.sizeLimits<t.size?(fruit.message("warning","文件大小不能大于 "+a(n.options.sizeLimits)),!1):!0}function d(t){var i=n(t),r=i.fileInput[0].files[0],u;r&&(u=w(r.name),s(i,r)?(i.text.text(u),p(t,r)):i.fileInput.val(""))}function g(i){var r=n(i);r.options.value?fruit.ajax({url:"/File/Get/"+r.options.value,success:function(n){r.options.files=n;t(i)}}):t(i)}function r(n){var i=n.lastIndexOf("."),t;if(i>-1){t=n.substr(i+1);switch(t.toLowerCase()){case"chm":case"doc":case"exe":case"jpg":case"pdf":case"ppt":case"rar":case"txt":case"xls":return"icon-ext-"+t.toLowerCase();case"docx":return"icon-ext-doc";case"xlsx":return"icon-ext-xls";case"7z":case"zip":return"icon-ext-rar"}}return"icon-ext-empty"}function t(t){var i=n(t),u;if(i.options.numberLimits==1)if(i.options.files.length){u=i.options.files[0];i.text.text(u.FileName).attr("title","点击下载").data("href",u.Path).css("cursor","pointer").on("click",function(){window.open($(this).data("href"))});i.delButton.data("Serial",u.Serial).show().on("click",function(){o(t,$(this).data("Serial"))});i.icon.prop("class","file-icon "+r(u.FileName))}else i.text.html("&nbsp;").removeAttr("title").css("cursor","default").removeData("href").off("click"),i.delButton.hide(),i.icon.prop("class","file-icon");else i.box.empty(),i.options.files.length&&$.each(i.options.files,function(){var n=this,u=$('<span class="file-item"><\/span>').appendTo(i.box).hover(function(){$(this).addClass("file-item-hover")},function(){$(this).removeClass("file-item-hover")}),f=$('<span class="file-icon">&nbsp;<\/span>').addClass(r(this.FileName)).appendTo(u);$('<span class="file-text"><\/span>').data("path","/File/Show?fileId="+i.options.value+"&serial="+n.Serial).click(function(){window.open($(this).data("path"))}).appendTo(u).text(n.FileName);$('<button class="file-affix" title="删除"><span class="icon icon-bullet_cross">&nbsp;<\/span><\/button>').data("Serial",n.Serial).appendTo(u).click(function(){o(t,$(this).data("Serial"))})})}function nt(t){var i=n(t),r;$(t).is(":visible")&&($(t).hide(),r="file_"+l++,i.button=$('<label for="'+r+'" data-for="'+r+'" class="file-selector" title="选择文件..."><span class="icon icon-folder_magnify">&nbsp;<\/span><\/label>').insertAfter(t),i.options.numberLimits==1?(i.delButton=$('<button class="file-affix" title="删除" style="display:none;"><span class="icon icon-bullet_cross">&nbsp;<\/span><\/button>').insertAfter(t),i.fileInput=$('<input type="file" id="'+r+'" style="position: absolute;left: -5000px;" '+(i.options.numberLimits!=1?"multiple":"")+" />").insertAfter(t).change(function(){d(t)}),i.text=$('<span class="file-text">&nbsp;<\/span>').insertAfter(t),i.icon=$('<span class="file-icon">&nbsp;<\/span>').insertAfter(t)):(i.fileInput=$('<input type="file" id="'+r+'" style="position: absolute;left: -5000px;" multiple />').insertAfter(t).change(function(){k(t)}),i.box=$('<span class="file-box"><\/span>').insertAfter(t)))}function n(n){var t=$.data(n,"file");return t||($.data(n,"file",{options:$.extend({},$.fn.file.defaults,$.parser.parseOptions(n))}),t=$.data(n,"file")),t}function c(n){var t=[];return $.each(n.files,function(i){/(jpg|jpeg|gif|png)$/i.test(this.FileName)?t.push("<a href=\"javascript:$.fn.file.showPictureWall('"+n.fileId+"', "+i+')" title="'+this.FileName+'"><img class="image-icon" src="'+this.Path+'"><\/a>&nbsp;'):t.push('<a href="/File/Show/?fileId='+n.fileId+"&serial="+this.Serial+'" target="_blank" title="'+this.FileName+'"><span class="icon '+r(this.FileName)+'">&nbsp;<\/span><\/a>&nbsp;')}),t=t.join(""),n.id&&$.each(n.id,function(){$("#"+n.id).html(t)}),t}var l=1,h;$.fn.file=function(t,i){if(typeof t=="string"){var r=$.fn.file.methods[t];if(r)return r(this,i)}return t=t||{},this.each(function(){var i=n(this);$.extend(i.options,t);nt(this)})};$.fn.file.cellShowCaches={};h=1;$.fn.file.showPictureWall=function(n,t){for(var r=$.fn.file.cellShowCaches["file"+n],f=0,u=[],i=0;i<r.files.length;i++)/(jpg|jpeg|gif|png)$/i.test(r.files[i].Path)&&(i==t&&(f=u.length),u.push(r.files[i].Path));$.pictureWall({images:u,index:f}).show()};$.fn.file.methods={getValue:function(t){var i=n(t[0]);return i.options.value},setValue:function(t,i){var r=n(t[0]);r.options.value=i;g(t[0])},createFileCell:function(n){var i,t,r;return n?(i="",t=$.fn.file.cellShowCaches["file"+n],t||(t=$.fn.file.cellShowCaches["file"+n]={fileId:n,id:[]},$.ajax("/File/Get/"+n,{method:"POST",success:function(n){t.files=n;c(t)}})),t.files?i=c({fileId:n,files:t.files}):(r="file_cell_"+h++,t.id.push(r),i='<span id="'+r+'"><\/span>'),i):""}};$.fn.file.defaults={value:null,files:[],typeLimits:"jpg,gif,png",numberLimits:1,sizeLimits:2097152,path:"",viewMode:"Default"};$(".easyui-file").file()});$(function(){function n(t){$.fn.daterange?$(".easyui-daterange").daterange({}):t>0&&setTimeout(function(){n(t-1)},100)}n(3)});fruit.databind=function(n,t){if(!(this instanceof fruit.databind))throw new Error("fruit.databind 只能使用 new 方式调用！");var i=this;i.id=Math.random();i.toString=function(){return i.id};i.parsed=!1;i.jq=$(n);i.jq.data("fruit_databind",this);i.jq.attr("fruit","databind");i.options=$.extend({},fruit.databind.default,t);i.binds=[];i.validate=function(){return $.each(i.binds,function(){this instanceof fruit.databind.default.binder.datagrid&&this.endEdit()}),i.jq.find(".validatebox-invalid").length==0};i.binderByElement=function(n){return i.binds.find(function(t){return t.jq[0]==n})};i.invoke=function(n,t){if($.isFunction(i.options[n]))return i.options[n].call(i,t);if($.isFunction(i[n]))return i[n](t);console.log("databind.invoke");var u=!1,r=undefined;return $.each(i.binds,function(){if($.isFunction(this[n])&&((u=!0,r=this[n].call(this,t),r===!1)||typeof r!="undefined"))return!1}),u||alert("未找到可用的 "+n+" 方法绑定"),console.log("databind.invoke result",r),r};i.load=function(n){typeof n=="string"&&(n={url:n});n=$.extend({},{method:"GET"},n);n.success=function(n){i.loadData(n)};fruit.ajax(n)};i.loadData=function(n){i.options.data=n;$.each(i.binds,function(){$.isFunction(this.bindData)&&this.bindData.call(this,n)})};i.clearData=function(n){$.each(i.binds,function(){$.isFunction(this.clearValue)&&this.clearValue.call(this,n)})};i.getData=function(n){var t={},u,r;if($.each(i.binds,function(){$.isFunction(this.getData)&&this.getData(t)}),$.isString(n)){for(u=n.split("."),r=0;r<u.length;r++){if(typeof t[u[r]]=="undefined")return undefined;t=t[u[r]]}return t}return t};i.init=function(){if(i.jq.find("[data-bind]").each(function(){var r=$(this).data("bind"),n=r.split(","),u,f;n[0].split(":").length==1&&(n.length==1?r+=":true":(n[0]=n[0]+":true",r=n.join(",")));eval("options = {"+r+"};");for(u in t)$.isFunction(i.options.binder[u])&&(f=new i.options.binder[u](i,this,t),i.binds.push(f),this.id&&(i.binds[this.id]=f))}),n!=document.body&&i.parsed!==!0){i.parsed=!0;$.parser.onComplete=function(){i.finshInit.call(i)};$.parser.parse(n);return}i.finshInit()};i.finshInit=function(){if(i.binds.grid instanceof fruit.databind.default.binder.datagrid||$('table[data-bind^="datagrid"]').length)$(n).on("dblclick",".datagrid-row",function(){var n=$(this).closest(".datagrid-view").find('>table[data-bind="datagrid"]');n.datagrid("clearSelections").datagrid("selectRow",parseInt($(this).attr("datagrid-row-index")));i.invoke("edit")});$(n).on("click",".group-filter .gf-item",function(){$(this).siblings().removeClass("selected").end().addClass("selected");$(this).siblings("input").val($(this).data("name"));i.invoke("searchClick")});$(".val>.easyui-combobox").combobox("resize","auto");i.options.onInit.call(i)};i.uninit=function(){var r,t;i.parsed=!1;(i.binds.grid||$('table[data-bind^="datagrid"]').length)&&$(n).off("dblclick",".datagrid-row");for(r in i.binds)t=i.binds[r],t&&typeof t.uninit=="function"&&t.uninit()};i.download=function(){var t=null,u;if($.each(i.binds,function(){if(this instanceof fruit.databind.default.binder.datagrid)return t=this,!1}),t!=null){var r=t.jq.data("datagrid").options,f={title:document.title,url:r.url,columns:r.columns,queryParams:r.queryParams},e=$('<iframe style="display:none;" id="downloadHelper"><\/iframe>').appendTo("body")[0],n=e.contentWindow.document;n&&(n.open(),n.write(""),n.writeln("<html><body><form id='downloadForm' name='downloadForm' method='post' action='/Home/Download'>"),n.writeln("<input type='hidden' name='data' value='"+JSON.stringify(f)+"'>"),n.writeln("<\/form><\/body><\/html>"),n.close(),u=n.forms[0],u&&u.submit())}};i.printClick=function(){var e=$(event.target).closest("[report]").attr("report"),n=$(event.target).closest("[report]").attr("report_params").split(","),t,o,r,u,f;if(n.length==1&&n[0].indexOf("#")==0){if(t=fruit.databind.root.binds[n[0].substr(1)],!t)return;var s=t.options.url,h=t.jq.datagrid("options").queryParams,r=$.extend({},h,{_report_:1});fruit.ajax({url:s,method:"GET",data:r,success:function(n){parent.showDocTab("icon-printer","打印","/Report.aspx?ReportFile="+e+"&condition="+encodeURIComponent(n))}});return}for(o=i.getData("form"),r=[],u=0;u<n.length;u++)f=n[u],r.push(f+"="+encodeURIComponent(o[f]));parent.showDocTab("icon-printer","打印","/Report.aspx?ReportFile="+e+"&"+r.join("&"))};i.getBindByType=function(n){var t=null;return $.each(i.binds,function(){if(this instanceof n)return t=this,!1}),t};i.popupSearch=function(){var n=i.getData("form"),t=i.getBindByType(fruit.databind.default.binder.datagrid);t.setLoadParams(n)};i.init()};fruit.databind.default={onInit:$.noop,onSave:$.noop};fruit.databind.get=function(n){return $(n).closest('[fruit="databind"]').data("fruit_databind")};fruit.databind.default.binder={};fruit.databind.from=function(n){return $(n).data("fruit_databind")||new fruit.databind(n)};fruit.popupSelected=function(n,t,i){var r={};$.each(i,function(i){this.length&&(r[this]=n[t[i]])});fruit.databind.root.loadData({form:r})};fruit.popupSelecteds=function(n,t,i){var r={},u=n.data("bind");eval("bindOpt = {"+u+"};");r[u.value.split(".")[1]]=t.join();r[u.text.split(".")[1]]=i.join();console.log("popupSelecteds",r);fruit.databind.root.loadData({form:r})};fruit.popupColumnSelected=function(n,t,i,r,u){$.each(fruit.databind.root.binds,function(){var f,o,e;if(this instanceof fruit.databind.default.binder.datagrid&&(f=this.options.edit_id,f>-1&&(o=this.jq.datagrid("getRows")[f],e=this.jq.datagrid("getEditors",f),e&&e.length)))return r.length&&(o[r]=u),$.each(i,function(i){if(this.length){var u=n[t[i]],r=e.find("field",this);r?r.actions.setValue(r.target,u):o[this]=u}}),!1})};fruit.popupColumnSelecteds=function(){alert("目前不支持在子表中使用多选弹出框！")};fruit.databind._id_=1;fruit.databind.newid=function(){return fruit.databind._id_++};$(function(){fruit.databind.root=new fruit.databind(document.body)});$(function(){var n=function(n){var t=this;this.element=n;this.jq=$(n);this.menu=$(this.jq.attr("menu"));this.menu.html('<div><img src="/Content/easyui/themes/default/images/loading.gif" align="absmiddle">正在查找关联...<\/div>');this.status=0;t.load=function(){t.status=1;var n="/api/Xt/"+t.jq.attr("code")+"?context="+t.jq.attr("context"),i=fruit.databind.root.getData("form");fruit.ajax({method:"POST",url:n,data:JSON.stringify(i),success:function(n){t.loaded(n)}})};t.loaded=function(n){t.status=2;console.log("loaded",n);n.length?(t.menu.empty(),$.each(n,function(){var n=this,i={text:this.Title};n.IconClass&&(i.iconCls=this.IconClass);n.Enabled||(i.disabled=!0);i.onclick=function(){n.Blank?window.open(n.Url):parent.showDocTab(n.IconClass,n.Title,n.Url)};t.menu.menu("appendItem",i)})):t.menu.html("<div>当前没有可用关联表单<\/div>")};this.menu.menu({onShow:function(){console.log("onShow");switch(t.status){case 0:t.load()}}})};$("#a_relations").each(function(){new n(this)})});+function(){"use strict";var n={lastUid:"",reports:[]},t=fruit.report={showDetialReports:function(n,t){var u=$("#subreports").show(),f=$("#subreports_mask").hide(),i=$(window).innerWidth(),r=u.innerHeight();$("#subreports div[drill-report-uid]").each(function(){var n=$(this).attr("drill-report-uid"),o=location.href.split("#")[0]+"/"+n,f={},u,e;for(u in t)f["parent_"+u]=t[u];$(this).empty();e=$("<div><\/div>").addClass("drill-report-panel").data("uid",n).appendTo(this).panel({href:o,queryParams:f,border:!1,doSize:!0,onLoad:function(){var u=new fruit.databind(e[0]),t=n+"_load";if($.isFunction(window[t]))window[t](u);else throw new Error("未找到子视图初始化函数 "+t);$(this).find("table[data-bind]").datagrid("resize",{width:i-8,height:r-68})},onResize:function(){console.log(i,r);$(this).find("table[data-bind]").datagrid("resize",{width:i-8,height:r-68})}})})},isDetialReport:function(n){return!!$('#subreports div[drill-report-uid="'+n+'"]').length},hasDetialReports:function(){return!!$("#subreports").length},showDrillReport:function(n,i,r){if(t.isDetialReport(n)){$("#subreports").tabs("select",i);t.showDetialReports(null,r);return}t.hasDrillReportRoot()||t.createDrillReportRoot();t.pushItem(n,i,r)},hasDrillReportRoot:function(){return!!n.root},createDrillReportRoot:function(){n.root=$('<div class="drill-report"><\/div>').appendTo(document.body);n.nav=$('<ul class="drill-report-nav"><li><a href="#" data-uid="">主视图<\/a><\/li><\/ul>').appendTo(n.root);n.content=$('<div class="drill-report-content"><\/div>').appendTo(n.root)},removeDrillReportRoot:function(){n.root.empty().remove();n.root=null},pushItem:function(t,i,r){var u,f;n.lastUid+="/"+t;var o=$('<li><a href="#" data-uid="'+n.lastUid+'">'+i+"<\/a><\/li>").appendTo(n.nav),s=location.href.split("#")[0]+"/"+t,e={};for(u in r)e["parent_"+u]=r[u];f=$("<div><\/div>").addClass("drill-report-panel").data("uid",n.lastUid).appendTo(n.content).panel({href:s,queryParams:e,border:!1,doSize:!0,onLoad:function(){var i=new fruit.databind(f[0]),n=t+"_load";if($.isFunction(window[n]))window[n](i);else throw new Error("未找到子视图初始化函数 "+n);}});n.reports.push({uid:t,li:o,panel:f})},popItem:function(){if(n.reports.length){var i=n.reports.pop(),r=n.lastUid.split("/");r.pop();n.lastUid=r.join("/");i.li.empty().remove();i.panel.empty().remove();n.reports.length||t.removeDrillReportRoot();return}},popToItem:function(i){while(n.reports.length>0&&n.reports.last().uid!=i)t.popItem()}};$(document).on("click",".drill-report-nav a[data-uid]",function(){var i=$(this).data("uid"),r;if(i!=n.lastUid){if(r=i.split("/"),r.length==1){t.removeDrillReportRoot();return}t.popToItem(i)}})}();fruit.databind.default.binder.click=function(n,t,i){var r=this;if(this.db=n,this.jq=$(t),this.options=fruit.parseOptions(i,n.options,"click"),this.jq.data("linkbutton"))this.jq.linkbutton({onClick:function(n){r.db.invoke(r.options.click,n)}});else this.jq.on("click",function(n){r.db.invoke(r.options.click,n)})};fruit.databind.default.binder.datasource=function(n,t,i){var r=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,n.options,"datasource");this.bindData=function(n){n!=null&&n!=undefined&&(typeof r.options.datasource!="string"||(n=fruit.findValue(n,r.options.datasource),typeof n!="undefined"))&&(r.jq.is(".easyui-combobox")?r.jq.combobox("loadData",n):r.jq.is(".easyui-radiobox")?r.jq.radiobox("loadData",n):r.jq.is(".easyui-combotree")&&r.jq.combotree("loadData",n))};$.isArray(this.options.datasource)&&r.bindData(this.options.datasource)};fruit.databind.default.binder.readOnly=function(n,t,i){var r=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,n.options,"readOnly");this.readOnly=function(n){r.jq.is(".easyui-datebox")?r.jq.datebox({disabled:n}):r.jq.prop("disabled","disabled")};this.options.readOnly===!0&&r.readOnly(r.options.readOnly)};fruit.databind.default.binder.text=function(n,t,i){var r=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,n.options,"text");this.setText=function(n){for(var i,t=0;t<fruit.databind.default.binder.text.setter.length;t++)if(i=fruit.databind.default.binder.text.setter[t],r.jq.is(i.selector))return i.set(r.jq,n);r.jq.text(n)};this.bindData=function(n){var t=fruit.findValue(n,r.options.text);typeof t!="undefined"&&r.setText(t)};this.getData=function(n){var i,t;if(r.options.text&&r.options.text.split(".").length==2){i=null;for(t of fruit.databind.default.binder.text.getter)if(r.jq.is(t.selector)){fruit.setValue(n,r.options.text,t.get(r.jq));return}}}};fruit.databind.default.binder.text.setter=[{selector:".easyui-popup",set:function(n,t){$.fn.popup.methods.setText(n,t)}}];fruit.databind.default.binder.text.getter=[{selector:".easyui-popup",get:function(n){return $.fn.popup.methods.getText(n)}}];fruit.databind.default.binder.readOnly=fruit.databind.default.binder.disable=function(n,t,i){var r=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,n.options,"readOnly","disable");this.bindData=function(n){if($.isString(r.options.readOnly)||$.isString(r.options.disable)){var t=!!fruit.findValue(n,r.options.readOnly||r.options.disable);r.setReadOnly(t)}};this.setReadOnly=function(n){r.jq.data("datebox")?r.jq.datebox({disabled:n}):r.jq.data("linkbutton")?r.jq.linkbutton(n?"disable":"enable"):r.jq.data("combobox")?r.jq.combobox({disabled:n}):r.jq.data("numberbox")?r.jq.numberbox({disabled:n}):n?r.jq.attr("disable","disable").attr("readonly","readonly"):r.jq.removeAttr("disable").removeAttr("readonly")};r.options.readOnly===!0||r.options.readOnly===!1?r.setReadOnly(r.options.readOnly):(r.options.disable===!0||r.options.disable===!1)&&r.setReadOnly(r.options.disable)};fruit.databind.default.binder.value=function(n,t,i){var r=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,n.options,"value","set");this.bindData=function(n){var t=fruit.findValue(n,r.options.value);typeof t!="undefined"&&r.setValue(t)};this.getValue=function(){for(var t,n=0;n<fruit.databind.default.binder.value.getter.length;n++)if(t=fruit.databind.default.binder.value.getter[n],r.jq.is(t.selector))return t.get(r.jq);return r.jq.val()};this.setValue=function(n){var t,i;if(r.options.set!==!1){for(t=0;t<fruit.databind.default.binder.value.setter.length;t++)if(i=fruit.databind.default.binder.value.setter[t],r.jq.is(i.selector))return i.set(r.jq,n);r.jq.val(n)}};this.getData=function(n){var f=r.getValue(),e=r.options.value,t=e.split("."),i,u;if($.isPlainObject(n)&&e){for(i=n,u=0;u<t.length-1;u++)i[t[u]]=i[t[u]]||{},i=i[t[u]];i[t[t.length-1]]=f}return f};this.clearValue=function(n){n?r.options.value.indexOf(n)==0&&r.setValue(""):r.setValue("")}};fruit.databind.default.binder.value.getter=[{selector:'[fruit-type="SelectUser"]',get:function(n){var i=n.combotree("tree").tree("getChecked"),t=[];return $.each(i,function(){this.nodeType!="Organize"&&t.push(this.id)}),t.join()}},{selector:"[richtextbox]",get:function(n){return n.data("ue")?n.data("ue").getContent():(n.data("ue",UE.getEditor(n.attr("richtextbox"))),"")}},{selector:".easyui-numberbox",get:function(n){return n.numberbox("getValue")}},{selector:".easyui-combobox",get:function(n){return n.combobox("getValue")}},{selector:".easyui-combotree",get:function(n){return n.combotree("getValue")}},{selector:".easyui-datebox",get:function(n){return n.datebox("getValue")}},{selector:".easyui-datetimebox",get:function(n){return n.datetimebox("getValue")}},{selector:".easyui-timebox",get:function(n){return n.timebox("getValue")}},{selector:".easyui-timespinner",get:function(n){return n.timespinner("getValue")}},{selector:'[type="checkbox"]',get:function(n){return n[0].checked?1:0}},{selector:".easyui-radiobox",get:function(n){return n.radiobox("getValue")}},{selector:".easyui-file",get:function(n){return n.file("getValue")}},{selector:".easyui-validatebox",get:function(n){return n.val()}}];fruit.databind.default.binder.value.setter=[{selector:"[richtextbox]",set:function(n,t){n.data("ue")?t&&n.data("ue").setContent(t):(n.data("ue",UE.getEditor(n.attr("richtextbox"))),n.data("ue").ready(function(){t&&n.data("ue").setContent(t)}))}},{selector:".easyui-numberbox",set:function(n,t){return n.numberbox("setValue",t)}},{selector:".easyui-combobox",set:function(n,t){return n.combobox("setValue",t)}},{selector:".easyui-combotree",set:function(n,t){return n.combotree("setValue",t)}},{selector:".easyui-datebox",set:function(n,t){return n.datebox("setValue",t)}},{selector:".easyui-datetimebox",set:function(n,t){t&&n.datetimebox("setValue",t.replace("T"," "))}},{selector:".easyui-timebox",set:function(n,t){return n.timebox("setValue",t)}},{selector:".easyui-timespinner",set:function(n,t){return n.timespinner("setValue",t)}},{selector:'[type="checkbox"]',set:function(n,t){return n[0].checked=typeof t=="boolean"?t:!!parseInt(t)}},{selector:".easyui-radiobox",set:function(n,t){return n.radiobox("setValue",t)}},{selector:".easyui-file",set:function(n,t){return n.file("setValue",t)}},{selector:".easyui-validatebox",set:function(n,t){n.val(t);n.validatebox("validate")}}];fruit.databind.default.binder.form=function(n,t,i){var r=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,n.options,"form","saveUrl","urlArgs");this.bindData=function(n){$.isPlainObject(n)&&this.loadData(n)};this.loadData=function(n){r.jq.form("load",n)};this.validate=function(){return r.jq.form("validate")};this.save=function(){var n=r.options.saveUrl;r.options.urlArgs&&(n+=r.options.urlArgs);r.jq.showLoading("正在提交数据…");fruit.ajax({method:"post",url:n,data:JSON.stringify(r.jq.serializeObject()),success:function(n){r.jq.hideLoading();r.db.invoke("onSave",n)}})}};fruit.databind.default.binder.checked=function(n,t,i){$(t).click(function(){n.invoke(i.checked,$(this)[0].checked)})};fruit.databind.default.binder.checklist=function(n,t,i){var r=this;n.tree=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,t,n.options,"checklist","url","saveUrl","urlArgs","idField","textField","checkField","checkValue","uncheckValue","method");this.options.itemTemplate=this.options.itemTemplate||this.jq.html();this.options=$.extend({idField:"Value",textField:"Text",checkField:"Selected",checkValue:!0,uncheckValue:!1},this.options);this.jq.empty();r.jq.addClass("fruit-checklist");this.bindData=function(n){typeof r.options.checklist=="string"&&(n=n[r.options.checklist]);$.isArray(n)&&r.loadData(n)};this.loadData=function(n){r.jq.empty();r.options.data=n;$.each(n,function(){var n=$(r.options.itemTemplate).bindData(this).attr("item-id",this[r.options.idField]).appendTo(r.jq);this[r.options.checkField]==r.options.checkValue&&n.addClass("selected")})};this.getChangeRows=function(){var n=[];return $.each(r.options.data,function(){this._row_state&&n.push(this)}),n};this.checkAll=function(n){$.each(r.options.data,function(){var t=this[r.options.checkField]==r.options.checkValue;t!=n&&r.check(this[r.options.idField],n)})};this.check=function(n,t){var i=r.options.data.find(r.options.idField,n),u;i&&(i.Selected=t,i._row_state=fruit.STATE_CHANGED,u=r.jq.find('[item-id="'+i[r.options.idField]+'"]'),t?u.addClass("selected"):u.removeClass("selected"))};this.setSelecteds=function(n){r.jq.find("li").removeClass("selected");$.each(n,function(){r.jq.find('li[item-id="'+this+'"]').addClass("selected")})};this.getSelecteds=function(){var n=[];return r.jq.find(".selected[item-id]").each(function(){n.push($(this).attr("item-id"))}),n};this.refresh=function(){var n,t;r.options.url&&(n=r.options.url,r.options.urlArgs&&(n+=r.options.urlArgs),r.jq.showLoading(),t={url:n,success:function(n){r.jq.hideLoading();r.loadData(n)}},r.options.method&&(t.method=r.options.method),fruit.ajax(t))};this.save=function(){var n=r.options.saveUrl,t;r.options.urlArgs&&(n+=r.options.urlArgs);t=this.getChangeRows();fruit.ajax({url:n,data:JSON.stringify(t),success:function(n){r.db.options.onSave(n)}})};this.jq.on("click","[item-id]",function(){var n=$(this).is(".selected");r.check($(this).attr("item-id"),!n)});this.refresh()};fruit.databind.default.binder.tree=function(n,t,i){var r=this;n.tree=this;r.db=n;r.jq=$(t);r.options=fruit.parseOptions(i,t,n.options,"tree","loadFilter","url","saveUrl","idField","treeField","iconField","parentField","parentNameField","fixSize","onSelect");r.options=$.extend({idField:"Id",treeField:"Name",edit_id:null,onSelect:$.noop},this.options);r.refresh=function(){r.jq.tree("reload")};r.jq.tree({onSelect:function(n){r.options.onSelect(n)}})};fruit.formatter={};fruit.formatter.Enable=function(n){return'<center><img src="/Content/images/'+((n||"").toString()=="true"||n==1?"checkmark.gif":"checknomark.gif")+'"/><\/center>'};fruit.formatter.Time=function(n){return n&&n.replace("T"," ")};fruit.formatter.Date=function(n){return $.isString(n)?n.split("T")[0]:""};fruit.formatter.Money=function(){};fruit.formatter.File=function(n){return $.fn.file.methods.createFileCell(n)},function(){var t=$.fn.datagrid.methods,r=$.fn.datagrid.methods.acceptChanges,n,i;$.extend($.fn.datagrid.methods,{acceptChanges:function(n){var i=[],t,u;for(n.parent().find("[datagrid-row-index]").each(function(t){n.datagrid("getRowState",t)==fruit.STATE_DELETED?i.push(t):n.datagrid("setRowState",{index:$.attr(this,"datagrid-row-index"),state:0})}),t=0;t<i.length;t++)u=i[t]-t,n.datagrid("deleteRow",u);r(n)},getRowState:function(n,i){var r=t.getRows(n)[i];return r&&r._row_state||0},setRowState:function(n,i){var u=t.getRows(n)[i.index],r;if(u){if(r=t.getPanel(n).find(".datagrid-row[datagrid-row-index="+i.index+"]"),r.length==0){console.warn("row loss where index "+i.index);return}r.removeClass("datagrid-row-new").removeClass("datagrid-row-change").removeClass("datagrid-row-delete");switch(i.rowstate){case 1:r.addClass("datagrid-row-new");break;case 2:r.addClass("datagrid-row-change");break;case 3:r.addClass("datagrid-row-delete")}u._row_state=i.rowstate}},getChangeRows:function(n){for(var f,r=t.getRows(n),u=[],i=0;i<r.length;i++)r[i]._row_state&&(f=$.extend({},r[i]),u.push(f));return u}});n=null;i=function(){};$.extend($.fn.datagrid.defaults.editors,{icons:{init:function(t){var r=$('<input type="text" class="datagrid-editable-input" />').appendTo(t),u=$('<input type="button" value=".." class="datagrid-editable-morebutton" />').appendTo(t).click(function(){var f,u,t;if(n==null){if(f=$('link[href$="icon.css"]'),f.length==0){alert("使用 icons 类型编辑器需要在当前页面引用 icon.css 样式表文件!");return}for(u=f[0].sheet.cssRules,n=$("<div><\/div>"),t=0;t<u.length;t++)u[t].selectorText.indexOf(".icon-")==0&&u[t].selectorText.indexOf("32")==-1&&$('<span class="icon-selector '+u[t].selectorText.substr(1)+'">&nbsp;<\/span>').appendTo(n).click(function(){var t=$(this).attr("class").split(" ")[1];n.dialog("close");i(t)});n.dialog({title:"选择图标",modal:!0,closed:!1,width:400,height:280})}else n.dialog("open");i=function(n){r.val(n)}});return r},destroy:function(){},getValue:function(n){return $(n).val()},setValue:function(n,t){$(n).val(t)},resize:function(n,t){$(n)._outerWidth(t-18)}},popup:{init:function(n,t){var i=$('<input type="text" class="datagrid-editable-input easyui-validatebox" />').appendTo(n);return i.popup(t),i.data("popup_options",t),i},destroy:function(n){$(n).popup("destroy")},getValue:function(n){return $(n).val()},setValue:function(n,t){var u,i,r;$(n).val(t);u=$(n).data("popup_options");u.textField&&(i=null,r=$(n).closest("tr.datagrid-row"),r.is("[node-id]")?i=fruit.databind.root.binds.grid.findItem(r.attr("node-id")):r.is("[datagrid-row-index]")&&(i=fruit.databind.root.binds.grid.findItem(parseInt(r.attr("datagrid-row-index")))),i&&i[u.textField]&&$.fn.popup.methods.setText(n,i[u.textField]))},resize:function(n,t){$(n).next()._outerWidth(t)}}})}();fruit.databind.default.binder.datagrid=function(n,t,i){var r=this,u;this.db=n;this.jq=$(t);this.jq.data("binder",r);this.options=fruit.parseOptions(i,t,n.options,"datagrid","autoload","loadFilter","url","saveUrl","idField","iconField","fixSize","toolbar","editMode","holdTotal","preQueryParams");this.options=$.extend({idField:"Id",edit_id:-1},this.options);this.fixSize=function(){var t=$(window).innerWidth(),i=$(window).innerHeight(),n,u;r.options.fixSize.h=="auto"?(n=0,$(".z-toolbar, #condition, #master,#tt>.tabs-header").each(function(){n+=$(this).marginHeight(!0)}),u=i-n-4,r.jq.datagrid("resize",{width:t-r.options.fixSize.w,height:u})):r.jq.datagrid("resize",{width:t-r.options.fixSize.w,height:i-r.options.fixSize.h})};this.add=function(n){if((n==undefined||n instanceof $.Event)&&(n={},n[r.options.idField]=""),n._id_=fruit.databind.newid(),!$.isFunction(r.db.options.onBeforeAdd)||r.db.options.onBeforeAdd(n,r)!==!1){var t=r.jq.datagrid("getRows").length;r.jq.datagrid("appendRow",n);r.jq.datagrid("selectRow",t);r.jq.datagrid("setRowState",{index:t,rowstate:fruit.STATE_NEW});r.edit()}};this.getRows=function(){return r.jq.datagrid("getRows")};this.setLoadParams=function(n){r.options.autoload===!1&&(r.options.autoload=!0,r.jq.datagrid("options").url=r.options.url);n==undefined&&(n={});r.options.preQueryParams&&(n=$.extend({},n,r.options.preQueryParams));r.options.holdTotal&&r.jq.datagrid("options").queryParams&&r.jq.datagrid("options").queryParams.total&&(n.total=r.jq.datagrid("options").queryParams.total);r.jq.datagrid("options").queryParams=n;r.jq.datagrid("load")};this.refresh=function(){r.options.autoload===!1&&(r.options.autoload=!0,r.jq.datagrid("options").url=r.options.url);r.jq.datagrid("reload")};this.edit=function(){var t,i,n;if(r.jq.attr("readonly"))return!1;n=r.jq.datagrid("getSelected");t=r.jq.datagrid("getRows").indexOf(n);t>-1&&(r.jq.datagrid("beginEdit",t),i=r.jq.datagrid("getEditors",t),n=r.jq.datagrid("getRows")[t],$.each(i,function(){if(this.type=="popup"&&n){var t=$(this.target).data().popup.options.textField;t&&n[t]&&$.fn.popup.methods.setText(this.target,n[t])}}),r.options.edit_id=t)};this.getEditingRows=function(){var n=[];return $.each(r.jq.datagrid("getPanel").find(".datagrid-row-editing[datagrid-row-index]"),function(){var t=parseInt($(this).attr("datagrid-row-index"));n.indexOf(t)==-1&&n.push(t)}),n};this.endEdit=function(){for(var i,t=r.getEditingRows(),n=0;n<t.length;n++)i=t[n],r.jq.datagrid("endEdit",t[n])};this.getSelected=function(){return r.jq.datagrid("getSelected")};this.getSelections=function(){return r.jq.datagrid("getSelections")};this.joinSelectedColumn=function(n){var t=[],i=r.getSelections();return $.each(i,function(){t.push(this[n])}),t.join()};this.delete=function(){var t=r.jq.datagrid("getSelections"),n=[];$.each(t,function(){var i=this,t=r.jq.datagrid("getRows").indexOf(i);t>-1&&(r.jq.datagrid("getRowState",t)==fruit.STATE_NEW?n.push(t):r.jq.datagrid("setRowState",{index:t,rowstate:fruit.STATE_DELETED}))});$.each(n,function(n){r.jq.datagrid("deleteRow",this-n)})};this.save=function(){if(r.endEdit(),!r.jq.datagrid("validateRow",r.options.edit_id)){fruit.message("error","请更正验证错误！");return}var n=r.jq.datagrid("getChangeRows");n.length>0?(r.jq.showLoading("正在保存数据…"),fruit.ajax({url:r.options.saveUrl||r.options.url,data:JSON.stringify(n),success:function(n){r.jq.hideLoading();$.isArray(n)&&r.jq.datagrid("loadData",n);r.jq.datagrid("acceptChanges");r.db.invoke("onSave")}})):r.db.invoke("onSave")};this.onEditing=function(n,t,i){r.jq.find('th[field="'+i+'"]').data("expression")||(r.calcColumn(n),r.updateSumRow())};this.calcColumn=function(n){var t=this.jq.datagrid("getEditors",n),i=this.jq.datagrid("getRows")[n],u=function(n,r){var u=t.find("field",r);return u?u.actions.getValue(u.target):i[r]};r.jq.find("th[data-expression]").each(function(){var s=$(this).data("expression"),e=$(this).attr("field"),h=s.replace(/\{([^\}]*)}/g,u),o=null,f;try{eval("result = "+h);f=t.find("field",e);f?f.actions.setValue(f.target,o):(i[e]=o,r.setCellText(n,e,o))}catch(c){}})};r.setCellText=function(n,t,i){var u=r.jq.datagrid("getPanel").find("tr[datagrid-row-index="+n+"]>td[field="+t+"]>.datagrid-cell");u&&u.text(i)};r.updateSumRow=function(){var n=r.getRows();r.setSumRow(n)};r.setSumRow=function(n){var i=r.jq.find('th[field][sumfield="true"]'),t;i.length>0&&(t={},$.each(n,function(){var n=this;i.each(function(){var i=$(this).attr("field");try{n[i]&&$.isNumeric(n[i])&&(t[i]||(t[i]=0),t[i]+=parseFloat(n[i]))}catch(r){}})}),r.jq.datagrid("reloadFooter",[t]))};r.findItem=function(n){return r.getRows()[n]};u={onSelect:function(){if(r.options.edit_id>-1)if(r.jq.datagrid("validateRow",r.options.edit_id))r.jq.datagrid("endEdit",r.options.edit_id),r.options.edit_id=-1;else return;r.options.editMode=="select"&&r.edit()},onBeginEdit:function(n,t){var i=r.jq.datagrid("getEditors",n),u=r.jq.datagrid("options");$.each(i,function(){var f=this,i=u.columns[0].find(function(n){return n.field==f.field});i&&i.editor&&i.editor.options&&i.editor.options.modifiable===!1&&(i.editor.options.disabled=t._row_state!=fruit.STATE_NEW,f.target.textbox(i.editor.options.disabled?"disable":"enable"));f.type=="numberbox"&&$(f.target).numberbox({onChange:function(i){r.onEditing(n,t,f.field,i)}})})},onEndEdit:function(n,t,i){!$.isEmptyObject(i)&&n>-1&&n<r.jq.datagrid("getRows").length&&t._row_state!=fruit.STATE_NEW&&r.jq.datagrid("setRowState",{index:n,rowstate:fruit.STATE_CHANGED})},onLoadSuccess:function(n){r.setSumRow(n.rows);$.isFunction(r.db.onLoadSuccess)&&r.db.onLoadSuccess.call(r.db,n)}};r.options.url&&(u.url=r.options.url,u.method=r.options.method||"get");r.options.holdTotal&&(u.onLoadSuccess=function(n){n.total&&(r.jq.datagrid("options").queryParams.total=n.total);$.isFunction(r.db.onLoadSuccess)&&r.db.onLoadSuccess.call(r.db,n)});r.options.preQueryParams&&(u.queryParams=r.options.preQueryParams);r.options.toolbar&&(u.toolbar=r.options.toolbar);r.options.autoload===!1&&(u.url=null);this.jq.datagrid(u);r.options.fixSize&&(r.fixSize(),$(window).resize(function(){r.fixSize()}))},function(){var t=$.fn.treegrid.methods.acceptChanges||$.fn.datagrid.methods.acceptChanges,n=$.fn.treegrid.methods;$.extend($.fn.treegrid.methods,{acceptChanges:function(n){t(n);n.parent().find("[node-id]").each(function(){n.treegrid("setRowState",{id:$.attr(this,"node-id"),state:0})})},getRowState:function(t,i){var r=n.find(t,i);return r&&r._row_state||0},setRowState:function(t,i){var u=n.find(t,i.id),r;if(u){if(r=$(".datagrid-row[node-id="+u._id+"]"),r.length==0){console.warn("row loss where "+u._id);return}r.removeClass("datagrid-row-new").removeClass("datagrid-row-change").removeClass("datagrid-row-delete");switch(i.rowstate){case 1:r.addClass("datagrid-row-new");break;case 2:r.addClass("datagrid-row-change");break;case 3:r.addClass("datagrid-row-delete")}u._row_state=i.rowstate}},getChangeRows:function(t){function r(n,t){for(var u,i=0;i<t.length;i++)t[i]._row_state&&(u=$.extend({},t[i]),u.children=undefined,n.push(u)),t[i].children&&t[i].children.length&&r(n,t[i].children)}var u=n.getData(t),i=[];return r(i,u),i}})}();fruit.databind.default.binder.treegrid=function(n,t,i){var r=this,u;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,t,n.options,"treegrid","loadFilter","url","saveUrl","idField","treeField","iconField","parentField","parentNameField","fixSize");this.options=$.extend({idField:"Id",treeField:"Name",edit_id:null},this.options);this.fixSize=function(){var t=$(window).innerWidth(),i=$(window).innerHeight(),n,u;r.options.fixSize.h=="auto"?(n=0,$(".z-toolbar, #condition, #master,#tt>.tabs-header").each(function(){n+=$(this).marginHeight(!0)}),u=i-n-4,r.jq.treegrid("resize",{width:t-r.options.fixSize.w,height:u})):r.jq.treegrid("resize",{width:t-r.options.fixSize.w,height:i-r.options.fixSize.h})};this.loadData=function(n){if(!$.isArray(n)){typeof r.options.treegrid=="string"&&r.loadData(n[r.options.treegrid]);return}return r.jq.treegrid("loadData",n),!1};this.getData=function(){return r.jq.treegrid("getData")};this.refresh=function(){r.jq.treegrid("reload")};this.getSelected=function(){return r.jq.treegrid("getSelected")};this.getSelections=function(){return r.jq.treegrid("getSelections")};this.getNewChildId=function(n){for(var u=r.jq.treegrid("getData"),f=n[r.options.idField],t=1,i;t<100;t++)if(i=f+(t>9?t:"0"+t),fruit.tree.findNodeData(u,i)==null)return i};this.select=function(n){this.jq.treegrid("select",n)};this.add=function(){var t=r.getSelected(),n;t==null&&(t=r.jq.treegrid("getData")[0]);n={_row_state:fruit.STATE_NEW};n._id=n[r.options.idField]=r.getNewChildId(t);n._parentId=t[r.options.idField];n[r.options.treeField]="";n[r.options.parentField]="";r.options.parentNameField&&(n[r.options.parentNameField]=t[r.options.treeField]);console.log("append",n);r.jq.treegrid("append",{parent:t[r.options.idField],data:[n]});n[r.options.parentField]=t[r.options.idField];r.select(n._id);r.edit()};this.edit=function(){var i=r.getSelected(),n,u;if(i){if(r.options.edit_id&&(r.jq.treegrid("endEdit",r.options.edit_id),r.options.edit_id=null),n=r.jq.treegrid("options"),u=$.grep(n.columns[0],function(t){return t.field==n.parentField&&t.editor&&(t.editor=="combotree"||t.editor.type=="combotree")}),u.length>0){var o=r.jq.treegrid("getSelected"),t=r.jq.treegrid("getData"),e=JSON.stringify(t),f=/_id/g;n.idField&&(f=new RegExp(n.idField,"g"));t=t.length&&t[0][n.treeField+"_RefText"]!=undefined?JSON.parse(e.replace(f,"id").replace(new RegExp(n.treeField+"_RefText","g"),"text")):JSON.parse(e.replace(f,"id").replace(new RegExp(n.treeField,"g"),"text"));fruit.tree.remove(t,function(t){return t.id==o[n.idField]});t.unshift({id:0,text:""});u[0].editor={type:"combotree",options:{data:t,onChange:function(r){var u=fruit.tree.findNodeData(t,r,n.idField);u&&n.parentNameField?i[n.parentNameField]=u.text:u&&u[n.treeField+"_RefText"]&&(i[n.parentField+"_RefText"]=u[n.treeField+"_RefText"])}}}}r.options.edit_id=i[r.options.idField];r.jq.treegrid("beginEdit",r.options.edit_id)}};this.getEditingRows=function(){var n=[];return $.each(r.jq.treegrid("getPanel").find(".datagrid-row-editing[node-id]"),function(){var t=$(this).attr("node-id");n.indexOf(t)==-1&&n.push(t)}),n};this.endEdit=function(){var n=r.getEditingRows();$.each(n,function(){console.log("endEdit",""+this);r.jq.treegrid("endEdit",""+this)})};this.delete=function(){var n=r.getSelected(),t;if(n){if(t=r.jq.treegrid("getRowState",n[r.options.idField]),t==fruit.STATE_NEW){r.jq.treegrid("remove",n[r.options.idField]);return}r.jq.treegrid("setRowState",{id:n[r.options.idField],rowstate:fruit.STATE_DELETED})}};this.save=function(){if(r.endEdit(),r.jq.treegrid("getPanel").find(".validatebox-invalid").length){fruit.message("error","请更正验证错误！");return}var n=r.jq.treegrid("getChangeRows");n.length>0?(r.jq.showLoading("正在保存数据…"),fruit.ajax({url:r.options.saveUrl,data:JSON.stringify(n),success:function(){r.jq.hideLoading();r.jq.treegrid("acceptChanges");r.db.invoke("onSave")}})):r.db.invoke("onSave")};this.findItem=function(n){var t=this.getData();return fruit.tree.findNodeData(t,n,r.options.idField)};u={onDblClickRow:function(n){r.jq.treegrid("unselectAll");r.jq.treegrid("select",n[r.options.idField]);r.db.invoke("edit")},onSelect:function(){r.options.edit_id&&(r.jq.treegrid("endEdit",r.options.edit_id),r.options.edit_id=null)},onAfterEdit:function(n){var t=n&&n._row_state||0;t!=fruit.STATE_NEW&&r.jq.treegrid("setRowState",{id:n._id,rowstate:fruit.STATE_CHANGED})}};this.jq.treegrid(u);r.options.fixSize&&(r.fixSize(),$(window).resize(function(){r.fixSize()}))};fruit.databind.default.binder.orgtree=function(n,t,i){var r=this;n.tree=this;this.db=n;this.jq=$(t);this.options=fruit.parseOptions(i,t,n.options,{nodeDblClick:$.noop},"url","idField","parentField","treeField","nodeDblClick","checkbox");this.options.checkbox&&(this.jq.addClass("org-tree-checkbox"),this.options.selectedNodes=[]);this.loadData=function(n){function t(n,i,u,f){for(var h,y,p,w,a,v,o,e,s=0,c=i>0?2:0,l=0;l<n.length;l++)h=n[l],h[r.options.parentField]==f&&(s++,o=$('<table cellspacing=0 cellpadding=0 align="center"><tr><\/tr><tr><\/tr><tr><\/tr><\/table>'),i>0&&($("<tr>").appendTo(o),$("<tr>").appendTo(o)),e=o.find("tr"),i>0&&(s==1?$('<td><table cellspacing=0 cellpadding=0 align="center" width="100%"><tr><td style="height:3px"><\/td><td style="height:3px;background-color:#000;"><\/td><\/tr><\/table><\/td>').appendTo(e[0]):$('<td style="height:3px;background-color:#000;"><\/td>').appendTo(e[0]),$('<td class="orgtree-vline"><\/td>').appendTo(e[1])),y=$('<table class="orgtree-node" cellspacing="0" cellpadding="0" align="center"><tr><td align="center">'+h[r.options.treeField]+"<\/td><\/tr><\/table>").attr("node-id",h[r.options.idField]),p=$('<td valign="top" align="center"><\/td>'),p.append(y).appendTo(e[c]),$('<td class="orgtree-vline"><\/td>').appendTo(e[c+1]),w=$('<td valign="top"><table cellspacing=0 cellpadding=0 align="center"><tr><\/tr><\/table><\/td>').appendTo(e[c+2]),i==0?o.appendTo(u):$('<td valign="top"><\/td>').appendTo(u).append(o),a=t(n,i+1,w.find("tr")[0],h[r.options.idField]),i>0&&(a==0?(v=e.length,$(e[v-1]).remove(),$(e[v-2]).remove()):a==1));return i>0&&(s==1?($(e[1]).remove(),$(e[0]).remove()):s>1&&$(e[0]).html('<td><table cellspacing=0 cellpadding=0 align="center" width="100%"><tr><td style="height:3px;background-color:#000;"><\/td><td style="height:3px;"><\/td><\/tr><\/table><\/td>')),s}r.options.data=n;this.jq.empty();t(n,0,this.jq,"0")};this.getData=function(){return r.options.data};this.getTreeData=function(n){$.isFunction(n)||(n=function(n){n.id=n[r.options.idField];n.text=n[r.options.treeField]});var t=r.options.data,i=fruit.tree.createLoadFilter(r.options.idField,r.options.parentField,"0",n);return i(t)};this.select=function(n){if(this.options.checkbox){var t=this.options.selectedNodes.indexOf(function(t){return t==n});t>-1?(this.options.selectedNodes.splice(t,1),this.jq.find('.orgtree-node[node-id="'+n+'"]').removeClass("orgtree-node-selected")):(this.options.selectedNodes.push(n),this.jq.find('.orgtree-node[node-id="'+n+'"]').addClass("orgtree-node-selected"))}else this.jq.find(".orgtree-node").removeClass("orgtree-node-selected"),r.options.selectedNode=r.options.data.find(r.options.idField,n),this.jq.find('.orgtree-node[node-id="'+n+'"]').addClass("orgtree-node-selected")};this.getSelected=function(){return r.options.selectedNode};this.getSelecteds=function(){return r.options.selectedNodes};this.setSelecteds=function(n){$.isString(n)&&(n=n.splice(","));this.options.selectedNodes=n;this.jq.find(".orgtree-node").removeClass("orgtree-node-selected");$.each(n,function(){r.jq.find('.orgtree-node[node-id="'+this+'"]').addClass("orgtree-node-selected")})};this.delete=function(){r.options.selectedNode&&(r.options.data.remove(r.options.selectedNode),r.options.selectedNode=null,r.loadData(r.options.data))};this.refresh=function(){r.options.url&&(r.jq.showLoading(),fruit.ajax({method:"get",url:r.options.url,success:function(n){r.jq.hideLoading();r.loadData(n)}}))};this.jq.on("click",".orgtree-node",function(){r.select.call(r,$.attr(this,"node-id"))});this.jq.on("dblclick",".orgtree-node",function(){var n=$.attr(this,"node-id");$.isFunction(r.options.nodeDblClick)?r.options.nodeDblClick.call(r,n):$.isString(r.options.nodeDblClick)&&r.db.invoke(r.options.nodeDblClick,n)});this.refresh()};fruit.databind.default.binder.cascadeFilter=function(n,t,i){function h(){return u.combobox("getValue")}function c(){var t=h(),u=typeof t=="undefined"||t==null||t=="",o=r.data("combobox"),i,n;!e&&o.data.length>0&&(r.data("combobox").allData=r.data("combobox").data,e=!0);i=r.data("combobox").allData;$.isArray(i)&&(n=[],u?f.FullIfParentNull&&(n=i):$.each(i,function(){this[f.ConditionField]==t&&n.push(this)}),r.combobox("loadData",n),n.length&&r.combobox("setValue",n[0].value))}var o=n,r=$(t),f=i.cascadeFilter,s="form."+f.ParentField,e=!1,u=o.jq.find(".easyui-combobox[data-bind*=\"value:'"+s+"'\"]");r.combobox({onLoadSuccess:function(){e=!0;r.data("combobox").allData=r.data("combobox").data}});u&&u.length&&u.combobox({onChange:function(n){c(n)}})};$(function(){var o=$(".z-toolbar>.condition_buttons"),e;if(o.length>0){var s=$('<div class="datagrid-btn-separator"><\/div>').insertBefore(o.find("a:first-child")),t=$('<div class="search-scheme-plane">').insertBefore(s),h=$('<a href="#"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">搜索方案<\/span><span class="l-btn-icon icon-application_form_magnify">&nbsp;<\/span><\/span><\/a>').appendTo(t),f=$('<div class="sspopup"><\/div>').appendTo(t),i=$('<div class="ssempty">当前没有保存搜索方案。<\/div>').appendTo(f),n=$('<div class="sslist"><\/div>').appendTo(f),r=null,u=null;t.on("click",".ssitem",function(){var n=$(this).data();if(n&&n.Data){var r=JSON.parse(n.Data),u=$(t).closest('[fruit="databind"]'),i=u.data("fruit_databind");i.loadData({serach:r});i.invoke("searchClick")}});e=$('<a href="#" class="easyui-linkbutton l-btn l-btn-small l-btn-plain"><span class="l-btn-left l-btn-icon-left"><span class="l-btn-text">新建搜索方案<\/span><span class="l-btn-icon icon-add">&nbsp;<\/span><\/span><\/a>').appendTo(f).on("click",function(){var o=$(this).closest('[fruit="databind"]'),s=o.data("fruit_databind"),f;if(u=s.getData("serach"),f=!0,$.each(u,function(n){var t=u[n],i=typeof t;if(i=="string"&&t.length>0)return f=!1,!1}),f){fruit.message("warning","至少设置一个条件才能保存搜索方案！");return}t.addClass("ss-newbox");i.hide();n.show();r=$('<div class="ssitem"><\/div>').appendTo(n);$('<input type="text" placeholder="搜索方案名称" class="ss-new" title="Enter:保存新方案&#10;Esc:取消" />').appendTo(r).focus().on("keydown",function(n){n.keyCode==27?h():n.keyCode==13&&l()}).on("blur",function(){h()});e.hide()});function l(){var t=r.find("input").val();if(t.length==0){fruit.message("warning","搜索方案名称是必须的！");return}if(n.find(".sstitle:contains('"+t+"')").length>0){fruit.message("warning","此名称已存在或包括在其它搜索方案名称中！");return}r.find("input").attr("disable","disable");$.ajax({url:"/Plugins/SearchScheme",method:"POST",data:{method:"add",title:t,pageCode:location.pathname.toUpperCase(),data:JSON.stringify(u)},dataType:"json"}).done(function(){h();c()})}function h(){t.removeClass("ss-newbox");e.show();r.remove();n.find(">*").length==0&&(n.hide(),i.show())}function a(t){var r=$('<div class="ssitem"><\/div>').appendTo(n).data(t);if($("<div>").addClass("sstitle").text(t.Title).appendTo(r),t.deleable)$('<a href="#"><\/a>').addClass("ssdel").appendTo(r).on("click",function(t){r.is(".ssitem-del")||(r.addClass("ssitem-del"),$.ajax({url:"/Plugins/SearchScheme",data:{method:"del",pageCode:location.pathname.toUpperCase(),id:r.data().Id},dataType:"json"}).done(function(t){t===!0&&(r.remove(),n.find(">*").length==0&&(n.hide(),i.show()))}));t.stopImmediatePropagation()})}function c(){$.ajax({url:"/Plugins/SearchScheme",data:{pageCode:location.pathname.toUpperCase()},dataType:"json"}).done(function(t){t.length==0?(i.show(),n.hide()):(i.hide(),n.empty().show(),$.each(t,function(){a(this)}))})}setTimeout(c,100)}});